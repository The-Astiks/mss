# Лабораторная работа № 4

## Аутентификация пользователей по стандарту 802.1X с использованием RADIUS-сервера
---
##  Протокол RADIUS

**RADIUS** (Remote Authentication Dial-In User Service)  представляет собой сетевой протокол – систему, которая определяет правила и соглашения для связи между сетевыми устройствами для удаленной аутентификации пользователей и ведения учета. Протокол RADIUS, который обычно используется интернет провайдерами (ISP), а также в корпоративных и образовательных сетях, выполняет три основные функции:

* Проверяет подлинность пользователей или устройств, прежде чем разрешить им доступ к сети 
* Авторизует этих пользователей или устройства для определенных сетевых служб 
* Учитывает и отслеживает использование этих услуг

    
Протокол RADIUS содержит множество технологических преимуществ для клиентов, в том числе: 
* Открытое и масштабируемое решение
* Широкая поддержка со стороны большой базы поставщиков
* Простая модификация
* Разделение процессов безопасности и коммуникаций
* Возможность адаптации к большинству систем безопасности
* Совместимость с любым устройством связи, поддерживающим клиентский протокол RADIUS
     
Клиент-серверная архитектура RADIUS обеспечивает открытое и масштабируемое решение, которое поддерживается большинством вендоров. Он может быть легко изменен в соответствии с различными ситуациями. Клиенты могут модифицировать серверы аутентификации на основе RADIUS для работы с большим количеством систем безопасности, представленных на рынке. Серверы RADIUS работают с любым устройством связи, поддерживающим клиентский протокол RADIUS.

## Компоненты RADIUS

---


| Компонент | Функция | Примеры |
| :-------: | ------- | :-----: |
| Пользователь или устройство | <ul> <li>Запрашивает доступ в сеть</li> </ul> | Ноутбук, ADSL-модем, VoIP-телефон |
| Network Access Server (NAS)|  <ul> <li> Обеспечивает доступ к сети для пользователя или устройства</li> </ul> | Коммутатор, беспроводная точка доступа |
| Authentication Server | <ul> <li>Получает запросы на проверку подлинности от NAS.</li> <li>Возвращает результаты проверки подлинности в NAS.</li> <li>Опционально запрашивает информацию о пользователе и конфигурации из базы данных или каталога.</li> <li>Может возвращать параметры конфигурации в NAS.</li> <li>Получает информацию для учета из NAS.</li> </ul> | FreeRADIUS, Radiator, IAS, NPS, ACS |
| Хранилище данных |<ul> <li> Дополнительная база данных или каталог с информацией об аутентификации и авторизации пользователя. Сервер RADIUS взаимодействует с хранилищем данных с помощью DB API или LDAP.</li> </ul> | SQL Database, Kerberos Service Server, LDAP Directory |

## Основные понятия

---

### AAA (authentication, authorization, accounting)


AAA расшифровывается как «аутентификация, авторизация и учет». ААА определяет архитектуру, которая проверяет подлинность и предоставляет авторизацию пользователям и учетным записям для их действий. Когда AAA не используется, архитектура описывается как «открытая», где любой может получить доступ и делать все, что угодно, без какого-либо отслеживания.



В систему можно включить только часть AAA. Например, если компания не заботится о выставлении счетов пользователям за использование сети, она может принять решение как аутентифицировать, так и авторизовать пользователей, но игнорировать активность пользователей. Аналогичным образом, система мониторинга может учитывать активность пользователя, но передать решения по аутентификации и авторизации другой части сети.



RADIUS - это один из нескольких протоколов аутентификации, авторизации и учета. Другие примеры протоколов AAA включают TACACS+ и DIAMETER. Без AAA сетевому администратору пришлось бы статически настраивать сеть. Даже в первые дни удаленного доступа сетевые администраторы находили статическую модель неадекватной. AAA обеспечивает гибкость сетевых политик. AAA также дает сетевым администраторам возможность управлять системами, без AAA им пришлось бы четко определять параметры подключения.



Сегодня распространение мобильных устройств, разнообразие сетевых потребителей и разнообразные методы доступа к сети в совокупности создают среду, которая предъявляет повышенные требования к AAA. 


AAA играет определенную роль практически во всех способах доступа к сети: 
* беспроводные точки доступа используют AAA для обеспечения безопасности
* сетевые устройства требуют AAA для обеспечения доступа
* все формы удаленного доступа используют AAA для авторизации удаленных пользователей.


### NAS (Network Access Server)


Сервер доступа к сети (NAS) действует как шлюз между пользователем и более широкой сетью. Когда пользователь пытается получить доступ к сети, NAS передает информацию для ау (например, имя пользователя и пароль) между пользователем и сервером RADIUS. Этот процесс называется сеансом аутентификации. Обратите внимание, что вход пользователя инициирует этот диалог сеанса аутентификации. Это ключевая концепция. 



В конце сеанса проверки подлинности сервер инструктирует NAS либо отклонить пользователя, либо запретить доступ к сети или принять пользователя и предоставить доступ к сети. Как только пользователь получает доступ к сети, ограничения безопасности (определенные сервером RADIUS) вводятся в действие NAS, который действует как шлюз и брандмауэр для этого пользователя.



Сервер RADIUS получает сводную информацию о действиях пользователя из NAS. Эта сводка включает в себя такие данные, как идентификационная информация сеанса, общее время в сети и общий трафик к пользователю и от него. Обратите внимание, что пользовательский трафик не проходит через RADIUS - сервер RADIUS имеет доступ к информации о пользователе только через сводку NAS.



Существует много различных типов серверов сетевого доступа (NAS). В корпоративной среде сетевые коммутаторы и точки беспроводного доступа действуют как NAS, гарантируя, что только авторизованные пользователи могут получить доступ к корпоративной сети. 


### Authentication (аутентификация)


Аутентификация относится к процессу проверки подлинности пользователя путем сопоставления учетных данных, предоставленных пользователем (например, имя, пароль), с теми, которые настроены на сервере AAA (например, имя, пароль). Если учетные данные совпадают, пользователь проходит проверку подлинности и получает доступ к сети. Если учетные данные не совпадают, проверка подлинности завершается ошибкой и доступ к сети запрещен. 



Проверка подлинности также может завершиться неудачей, если учетные данные пользователя введены неправильно. Например, политика сайта может разрешить доступ пользователя к сети из локального местоположения с использованием пароля открытого текста. Однако, если тот же пароль вводится пользователем из удаленного местоположения, в доступе может быть отказано.



Интернет-провайдер также может запретить доступ к сети аутентифицированным пользователям, если действие учетной записи пользователя было приостановлено. Администратор также может разрешить ограниченный доступ к сети неизвестным пользователям. </div>


###  Authorization (авторизация)


Авторизация относится к процессу определения того, какие разрешения предоставляются пользователю. Например, пользователю могут быть разрешены или не разрешены определенные виды доступа к сети или разрешено выполнять определенные команды.



NAS отправляет запрос (пакет информации о пользователе) и сервер RADIUS либо разрешает, либо отклоняет авторизацию, основываясь исключительно на информации в запросе, отправленном NAS. В каждом случае RADIUS-сервер управляет политикой авторизации, а NAS применяет эту политику. Запрос NAS на самом деле представляет собой набор инструкций. Например, NAS может отправить серверу RADIUS запрос, содержащий следующую информацию о пользователе:

    «имя пользователя – Боб», «пароль – Привет», «IP-адрес - 192.0.2.34»


Как только сервер получает запрос, он использует эту информацию, чтобы выяснить, какими свойствами должен обладать пользователь (т.е. «Боб» говорит, что у него/нее IP-адрес 192.0.2.34, противоречат ли записи сервера этому утверждению?).



Затем сервер отправляет ответ на NAS. Ответ содержит ряд утверждений о том, какими свойствами должен обладать пользователь:


    «имя пользователя – Боб», «IP-адрес - 192.0.2.78»


Обратите внимание, что сервер RADIUS не может запрашивать дополнительную информацию у NAS. В отличие от систем SQL, RADIUS ограничен в том смысле, что он не может выполнять сложные запросы. В SQL такие запросы, как "ВЫБЕРИТЕ имя из таблицы, где ipaddress = 192.0.2.34", являются общими. RADIUS не обладает такой возможностью. Вместо этого RADIUS делает заявления только о том, что есть и что должно быть. После получения ответа от сервера, NAS пытается применить эти свойства к пользователю. Если свойства не могут быть применены, NAS закрывает соединение.


###  Accounting (учёт)


Учет относится к учету ресурсов, потребляемых пользователем в течение времени, пока он находится в сети. Собранная информация может включать в себя количество используемого системного времени, объем отправленных данных или количество данных, полученных пользователем во время сеанса. 

   

Во время сетевого сеанса NAS периодически отправляет на сервер отчет об активности пользователя. Этот учет представляет собой сводку, а не полную копию всего трафика. 



Интернет-провайдеры являются крупными потребителями учетных данных, поскольку каждому пользователю выставляется счет за каждую минуту работы в сети. Однако исторически корпорации не полагались на информацию сетевого учета, собираемую RADIUS, поскольку сотрудникам традиционно не выставлялись счета за доступ к сети. Однако по мере того, как их потребность в постоянном мониторинге сети возрастает, возрастает и потребность в хранении и обработке учетной информации.



Отчетная сводка, отправляемая NAS на сервер, не содержит подробной информации, такой как посещенные веб-сайты или даже количество байтов, переданных с использованием определенного протокола (SMTP, HTTP и так далее). Этот тип подробной информации доступен только для NAS, и он не отправляет эти данные на сервер.



Если требуется подробная информация об активности пользователя, сетевые администраторы могут получить ее с помощью других протоколов, таких как sFlow или NetFlow. Однако эти протоколы не интегрированы в системы RADIUS. Сетевым администраторам часто бывает трудно связать все воедино, чтобы получить более полное представление об активности пользователей.


###  EAP (Extensible Authentication Protocol)
    

EAP (Extensible Authentication Protocol) — протокол определяющий подход к процедуре аутентификации (не определяет конкретный механизм аутентификации). На основе этого подхода могут быть реализованы различные механизмы аутентификации, называемые методы EAP. EAP определяет формат сообщений, а каждый протокол использующий EAP определяет способ инкапсуляции сообщений EAP в свой формат.


###  EAPOL (EAP over LANs)
    

EAPOL (EAP over LANs) — протокол определяющий способ инкапсуляции, который позволяет передавать пакеты EAP между supplicant и аутентификатором в локальных проводных сетях. 


###  PAE (Port Access Entity)

PAE (Port Access Entity) — отвечает за выполнение алгоритмов и протоколов. 

## Принцип работы

---


Протокол <strong>802.1X</strong> работает на канальном уровне и определяет механизм контроля доступа к сети на основе принадлежности к порту (в контексте стандарта порт — точка подключения к сети). Наибольшее распространение протокол получил в беспроводных сетях.



Согласно протоколу <strong>802.1X</strong> доступ к сети получают только клиенты прошедшие аутентификацию, если аутентификация не была пройдена, доступ с соответствующего порта будет запрещен. 

  
  
<p align="center">
<img src=http://xgu.ru/w/images/5/53/Dot1x.jpeg>
</p>
  

<strong>Supplicant</strong> — устройство (компьютер, ноутбук или др.), которое запрашивает доступ к сети у аутентификатора (коммутатора или точки доступа) и отвечает на его запросы. На клиенте должно быть установлено (или встроено) программное обеспечение работающее по протоколу <strong>802.1X</strong>.


<strong>Authenticator</strong> (аутентификатор) — устройство, контролирующее физический доступ к сети, основываясь на статусе аутентификации клиента. Выполняет роль посредника (proxy) между клиентом и сервером аутентификации.


<strong>Authentication Server</strong> (cервер аутентификации) — осуществляет аутентификацию клиента. Сервер аутентификации проверяет данные клиента и сообщает аутентификатору разрешен ли клиенту доступ к сети.


<p align="center">
<img src=http://xgu.ru/w/images/c/ca/MD5.jpeg>
</p>


1.	Клиент отправляет сообщение EAPOL-старт аутентификатору 
2.	Аутентификатор отправляет клиенту EAP-Запрос и клиент отвечает EAP-Ответом 
3.	Аутентификатор инкапсулирует ответ в формат RADIUS и пересылает ответ серверу аутентификации 
4.	Сервер аутентификации отправляет EAP-MD5 Challenge клиенту, а клиент присылает ответ (передает сообщения аутентификатор соответствующим образом инкапсулируя и деинкапсулируя фреймы) 
5.	Сервер аутентификации подтверждает подлинность клиента и сообщает аутентификатору о необходимости разрешить доступ клиента к сети 
6.	Аутентификатор авторизует порт и клиент получает доступ к сети 


## Топология сети, используемая в лабораторной работе

---

<strong>RADIUS-сервер</strong> является удаленным сервером на базе ОС GNU/Linux и открытого программного обеспечения <a href="https://freeradius.org/">freeRADIUS</a> и доступен по адресу <strong>172.17.9.151</strong> только в рамках сети <b>НИУ МИЭТ</b>.


<p align="center">
<img src=./src/topo.jpg>
</p>

## Топология сети в eNSP

---


Устройства в топологии <b>eNSP</b> соединяются с сетью института через Cloud. Настройки Cloud <b>аналогичны</b> настройкам Cloud из <a href="https://github.com/The-Astiks/mss/blob/8a95d6672b1f0aecdbed42e2979ff9d119ab9bfb/%D0%9C%D0%A1%D0%A1%20%E2%84%963.pdf">лабораторной работы № 3</a>.

    
<p align="center">
<img src=./src/ensp_topo.jpg> <br></br>
</p>


### Таблица 1 - Планирование VLAN

---

| VLAN | Описание |
| :--: | :------: |
| VLAN 100 | Для управления AP |
| VLAN 101 | Для беспроводных клиентов |
| VLAN 102 | Для управления сетевыми устройствами |
| VLAN 103 | Соединение между Sw-Core и Router |

<br></br>

### Таблица 2 - Планирование IP-адресации

---

| Устройство | Интерфейс | IP-адрес / Маска |
| :--------: | :-------: | :--------------: |
| Sw-Core | VLANIF 101 | 10.0.101.1/24 |
| Sw-Core | VLANIF 102 | 10.0.102.1/24 |
| Sw-Core | VLANIF 103 | 10.0.103.1/24 |
| Switch | VLANIF 102 | 10.0.102.2/24 |
| AC | VLANIF 100 | 10.0.100.1/24 |
| AC | VLANIF 102 | 10.0.102.3/24 |
| Router | GE 0/0/0  | 10.0.103.2/24 |
| Router | GE 0/0/1  | Получение по DHCP |

<br></br>

### Таблица 3 - Параметры портов

---

| Устройство | Порты | Тип порта | Настройки VLAN |
| :--------: | :---: | :-------: | -------------- |
| Sw-Core | GE 0/0/1 | Access | PVID: 103 |
| Sw-Core | GE 0/0/2 | Trunk | Allow-pass VLAN: 100, 102 |
| Sw-Core | GE 0/0/3 | Trunk  | Allow-pass VLAN: 100, 101, 102 |
| Switch | GE 0/0/1 | Trunk | Allow-pass VLAN: 100, 101, 102 |
| Switch | GE 0/0/2 | Trunk | Allow-pass VLAN: 100, 101 <br> PVID: 100 |
| AC | GE 0/0/1 | Trunk | Allow-pass VLAN: 100, 102 |

<br></br>

### Таблица 4 - Планирование данных WLAN

---

| Элемент | Конфигурация |
| :-----: | ------------ |
| DHCP-сервер | AC функционирует как DHCP-сервер для назначения IP-адресов точкам доступа (AP). <br> Sw-Core функционирует как DHCP-сервер для назначения IP-адресов STA. |
| Пул IP-адресов для AP | 10.0.100.2 – 10.0.100.254 |
| Пул IP-адресов для STA | 10.0.101.2 – 10.0.101.254 |
| Параметры аутентификации RADIUS | Шаблон RADIUS-сервера: wlan-net <br> IP-адрес: 172.17.9.151 <br> Порт аутентификации: 1812 <br> Общий ключ: test2 <br> Схема аутентификации: wlan-net |
| Профиль доступа 802.1x | Имя: wlan-net <br> Режим аутентификации: EAP |
| Профиль аутентификации | Имя: wlan-net <br> Привязанные профили и схемы: <br> <ul> <li> профиль доступа 802.1x: wlan-net</li> <li> шаблон RADIUS-сервера: wlan-net </li> <li> схема аутентификации RADIUS: wlan-net </li> </ul> |
| Группа AP | Имя: wlan-net <br> Привязанные профили: <br> <ul> <li> профиль VAP: wlan-net </li> <li> профиль регулятивного домена: wlan-net </li> </ul>|
| Профиль регулятивного домена | Имя: wlan-net <br> Код страны: RU |
| Профиль SSID | Имя: wlan-net <br> Имя SSID: wlan-net |
| Профиль безопасности | Имя: wlan-net <br> Политика безопасности: WPA-WPA2+802.1X+AES |
| Профиль VAP | Имя: wlan-net <br> Режим: direct-forward <br> Service VLAN: VLAN 101 <br> Привязанные профили: <ul> <li> профиль SSID: wlan-net </li> <li>	профиль безопасности: wlan-net </li> <li> профиль аутентификации: wlan-net </li> </ul>|

## Процедура конфигурирования:

---

#### 1. Проведите первоначальную настройку.

* Настройте устройствам имена.
* Создайте VLAN на устройствах и задайте им описания.
    
#### 2.	Настройка интерфейсов L2 и L3.

* Настройте интерфейсы GE и VLANIF на коммутаторах, добавьте интерфейсам описание.
* Настройте интерфейсы маршрутизатора.
* Настройте интерфейсы GE и VLANIF на AC.

  **Примечание:** всем настроенным в данном пункте интерфейсам должно быть добавлено описание.

#### 3.	Настройте Sw-Core и AC в качестве DHCP-серверов для STA и AP соответственно.  
#### 4.	Настройте статические маршруты на всех устройствах, где это необходимо.  
#### 5.	Настройте NAT на маршрутизаторе, чтобы устройства могли выйти в сеть.  
#### 6.	Настройте параметры WLAN на AC.  

* Создайте группу AP.
* Создайте профиль регулятивного домена, настройте код страны и привяжите профиль к группе AP.
* Настройте интерфейс-источник capwap на AC.
* Импортируйте AP на AC и добавьте в группу **wlan-net**. Настройте имя для AP.
* После включения AP запустите команду **display ap all**, чтобы проверить состояние AP. Если в поле **State** отображается **nor**, то AP вошла в сеть.
* Настройте аутентификацию 802.1x на AC.
 
  * **Настройте параметры аутентификации RADIUS.** 
          
    Создайте шаблон сервера RADIUS.
          
    ```
    [AC-wlan-view] quit
    [AC] radius-server template wlan-net
    [AC-radius-wlan-net] radius-server authentication 172.17.9.151 1812
    [AC-radius-wlan-net] radius-server shared-key cipher test2
    [AC-radius-wlan-net] quit
    ```
          
    Создайте схему аутентификации RADIUS.
          
          
    ```         
    [AC] aaa
    [AC-aaa] authentication-scheme wlan-net
    [AC-aaa-authen-wlan-net] authentication-mode radius
    [AC-aaa-authen-wlan-net] quit
    [AC-aaa] quit
    ```          
          
  * **Настройте профиль доступа 802.1x для управления параметрами контроля доступа 802.1x.**
          
    Создайте профиль доступа 802.1x **wlan-net**.
    
    ```
    [AC] dot1x-access-profile name wlan-net
    ```
    Настройте аутентификацию ретранслятора EAP.
    
    ```
    [AC-dot1x-access-profile-wlan-net] dot1x authentication-method eap
    [AC-dot1x-access-profile-wlan-net] quit
    ```
  * **Создайте профиль аутентификации wlan-net и привяжите его к профилю доступа 802.1x, схеме аутентификации и шаблону сервера RADIUS.**
      
    ```
    [AC] authentication-profile name wlan-net
    [AC-authentication-profile-wlan-net] dot1x-access-profile wlan-net
    [AC-authentication-profile-wlan-net] authentication-scheme wlan-net
    [AC-authentication-profile-wlan-net] radius-server wlan-net
    [AC-authentication-profile-wlan-net] quit
    ```
  * **Настройте параметры службы WLAN.**
    
    Создайте профиль безопасности **wlan-net** и установите политику безопасности в профиле.
    
    ```
    [AC] wlan
    [AC-wlan-view] security-profile name wlan-net
    [AC-wlan-sec-prof-wlan-net] security wpa-wpa2 dot1x aes
    [AC-wlan-sec-prof-wlan-net] quit
    ```
    Создайте профиль SSID **wlan-net** и установите имя SSID **wlan-net**.
    
    ```
    [AC-wlan-view] ssid-profile name wlan-net
    [AC-wlan-ssid-prof-wlan-net] ssid wlan-net
    [AC-wlan-ssid-prof-wlan-net] quit
    ```
    Создайте профиль VAP **wlan-net**, настройте режим прямой пересылки данных, Service VLAN и привяжите профиль безопасности, профиль аутентификации и профиль SSID к профилю VAP.
    
    ```
    [AC-wlan-view] vap-profile name wlan-net
    [AC-wlan-vap-prof-wlan-net] forward-mode direct-forward
    [AC-wlan-vap-prof-wlan-net] service-vlan vlan-id 101
    [AC-wlan-vap-prof-wlan-net] security-profile wlan-net
    [AC-wlan-vap-prof-wlan-net] authentication-profile wlan-net
    [AC-wlan-vap-prof-wlan-net] ssid-profile wlan-net
    [AC-wlan-vap-prof-wlan-net] quit
    ```
    
    Привяжите профиль VAP **wlan-net** к группе AP и примените профиль к радиомодулям точки доступа.
    
    ```
    [AC-wlan-view] ap-group name wlan-net
    [AC-wlan-ap-group-wlan-net] vap-profile wlan-net wlan 1 radio all
    [AC-wlan-ap-group-wlan-net] quit
    [AC-wlan-view] quit
    ```
  * **Проверьте правильность конфигурации AAA.**  
    
    На RADIUS-сервере создана учетная запись:
    
    **Логин**: test  
    **Пароль**: test
    
    Проверьте работоспособность конфигурации  с помощью команды **test-aaa**.
    
    ```
    [AC]test-aaa test test radius-template wlan-net
    Info: Account test succeed.
    ```





       

          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          


